<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
        <title>Hex</title>
		<link rel="stylesheet" href="style.css" />
		<script src="ext_lib/socket.io/socket.io.js"></script>
		<script src="ext_lib/d3.v3.min.js"></script>
		<script src="myHex.js"></script>
		<script>
		console.log('start page');
		var params=new Object();
	
		var tmp=window.location.search.substr(1).split("&");
		for (i=0; i<tmp.length; i++)
		{
			data=tmp[i].split("=");
			params[data[0]]=data[1];		
		}
		var socket = io.connect();
		socket.on('data', function (data) {
			var margin = {top: 0, right: 0, bottom: 0, left: 0},
			width = 400 - margin.left - margin.right,
			height = 400 - margin.top - margin.bottom;
			
			var radius = 30;
			var hexbin = d3.hexbin()
				.size([width, height])
				.radius(radius);
			document.oncontextmenu = function() {
				return false;
			}
			var svg = d3.select("#drawArea")
				.append("svg")
			    .append("g");
			function Update(data)
			{
				console.log('start update');
				var i=0;
				var points = [];
				for (hex in data) {
				  points[i++]=data[hex];
				}
				
				var chex=svg.selectAll(".hexagon")
					.data(hexbin(points), function(d) { return d.name+d.q+d.r; })
					.attr("class", "old");
				
				chex.enter().append("g")
					.attr("class", "hexagon")
					.attr("transform", function(d) { return "translate("+ (d.x +width/2) + ","+ (d.y+height/2) + ")"; })
					.on("click", function(d){socket.emit('move',{q:d.q,r:d.r});});
				
				chex.append("path")
					.attr("d", function(d) { return hexbin.hexagon(); })
					.attr('fill', function(d){return d.fill;})
					.attr('stroke', function(d){return d.stroke;})
					.attr('stroke-width', function(d){return d.stroke_width;})
					.on("mouseover", function(d){d3.select(this).style("fill", "black");})
					.on("mouseout", function(d){d3.select(this).style("fill", d.fill);});
				
				chex.append("image")
					.attr("xlink:href", function(d) {return d.img;})
					.attr("x", -10)
					.attr("y", -10)
					.attr("width", 20)
					.attr("height", 20);
					
				chex.exit().remove();
				
				console.log('end update');
			};
			Update(data);
			socket.on('maj', function (data) {
				Update(data)
			});
		  });
		</script>
	</head>
	<body>
		<header>
			<h1>HEX</h1>
		</header>
		<nav>
			<ul>
				<li><a href="index.html">Accueil</a></li>
				<li><a href="forum.html">Forum</a></li>
				<li><a href="contact.html">Contact</a></li>
			</ul>
		</nav>
		<section>
			<h1>Ma section de page</h1>
			<article id='drawArea'> </article>
			<aside>
				<p>Bla bla bla bla</p>
			</aside>
		</section>
		<footer>
			<p>FOOT</p>
		</footer>
    </body>
</html>